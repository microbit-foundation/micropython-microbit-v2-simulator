<!doctype html>
<html>
  <head>
    <title>Example simulator embedding</title>
    <style>
      .container {
        display: flex;
      }
      iframe {
        width: 400px;
        height: 100vh;
      }
      button, textarea, select {
        display: block;
        margin-top: 0.25em;
        margin-bottom: 0.25em;
        padding: 0.5em;
        border: 2px solid black;
        background-color: white;
      }
      textarea {
        white-space: nowrap;
        width: calc(100% - 15px);
      }
      .io {
        display: flex;
        flex-direction: column;
      }
      .terminal {
        margin-bottom: 0.5em;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <iframe id="simulator" src="index.html" title="Simulator" frameborder="0" scrolling="no"></iframe>
      <div class="io">
        <div id="term"></div>
        <div class="samples">
          <select id="sample">
            <!-- option values correspond to filenames in the examples folder -->
            <option value="background">Background music and display</option>
            <option value="buttons">Buttons</option>
            <option value="display">Display</option>
            <option value="music">Music</option>
            <option value="sensors">Sensors</option>
          </select>
          <textarea id="program" rows="10">
          </textarea>
          <button id="run">Run</button>
        </div>
      </div>
    </div>
    <script src="term.js"></script>
    <script>
      // Connect the simulator REPL to a terminal.
      const simulator = document.querySelector("#simulator").contentWindow;
      const term = new Terminal({
        cols: 80,
        rows: 24,
        useStyle: true,
        screenKeys: true,
        cursorBlink: false
      });
      term.open(document.getElementById("term"));
      term.removeAllListeners('data');
      term.on('data', function(data) {
        simulator.postMessage({
          kind: "serial_input",
          data
        });
      });

      const readyCallbacks = [];
      window.addEventListener("message", (e) => {
        if (e.source === simulator) {
          switch (e.data.kind) {
            case "serial_output": {
              term.write(e.data.data);
              break;
            }
            case "ready": {
              while (readyCallbacks.length) {
                readyCallbacks.pop()();
              }
              break;
            }
          }
        }
      })

      // Support for running samples via the REPL.
      // There is no filesystem support for the moment.
      const sample = document.querySelector("#sample");
      const program = document.querySelector("#program");
      async function fetchProgram(name) {
        const response = await fetch(`examples/${name}.py`)
        if (response.ok) {
          const text = await response.text();
          program.value = text;
        } else {
          program.value = `# No matching example found for ${name}`
        }
      }
      sample.addEventListener("change", async () => {
        fetchProgram(sample.value);
      });
      fetchProgram(sample.value);

      document.querySelector("#run").addEventListener("click", async () => {
        simulator.postMessage({
          kind: "serial_input",
          // Ctrl-C to interrupt, Ctrl-D to reboot (straight to REPL as no program)
          data: `\x03\x04`
        });

        // Wait for the ready message after the reboot.
        await new Promise((resolve) => readyCallbacks.push(resolve));
        
        simulator.postMessage({
          kind: "serial_input",
          // Ctrl-E to enter paste mode and Ctrl-D to finish
          data: `\x05${program.value}\x04`.replace(/\n/g, "\r")
        });
      })
    </script>
  </body>
</html>
